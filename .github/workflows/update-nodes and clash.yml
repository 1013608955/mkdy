name: èŠ‚ç‚¹æ›´æ–° + Clashé…ç½®è½¬æ¢ï¼ˆæ¯1å°æ—¶ï¼‰

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:       # ä¿ç•™æ‰‹åŠ¨è§¦å‘

jobs:
  update-and-convert:  # åˆå¹¶ä¸ºä¸€ä¸ªJobï¼Œæ­¥éª¤æŒ‰é¡ºåºæ‰§è¡Œ
    runs-on: ubuntu-latest
    timeout-minutes: 30  # åˆç†è®¾ç½®è¶…æ—¶ï¼ˆæ•´ä½“æµç¨‹â‰¤5åˆ†é’Ÿï¼‰
    steps:
      # ========== ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆå¸¦PATæƒé™ï¼Œç¡®ä¿åç»­æ¨é€ï¼‰ ==========
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          token: ${{ secrets.PAT_TOKEN }}  # å¤ç”¨ä½ çš„PATä»¤ç‰Œ
          persist-credentials: true        # ä¿ç•™å‡­è¯ï¼Œæ–¹ä¾¿åç»­æ¨é€

      # ========== ç¬¬äºŒæ­¥ï¼šæ›´æ–°s1.txtï¼ˆåŸç¬¬äºŒä¸ªYAMLçš„æ ¸å¿ƒé€»è¾‘ï¼‰ ==========
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: å®‰è£…Pythonä¾èµ–
        run: pip install requests

      - name: è¿è¡ŒèŠ‚ç‚¹æ›´æ–°è„šæœ¬ï¼ˆç”Ÿæˆæœ€æ–°s1.txtï¼‰
        run: python update_nodes.py
        env:
          PYTHONUNBUFFERED: "1"  # å®æ—¶è¾“å‡ºæ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥

      - name: æäº¤å¹¶æ¨é€æ›´æ–°åçš„s1.txt
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # ä»…å½“s1.txtæœ‰å˜æ›´æ—¶æäº¤æ¨é€
          if [ -f s1.txt ] && [ $(git diff --name-only s1.txt | wc -l) -gt 0 ]; then
            git add s1.txt
            git commit -m "å¤šæ¥æº+Realityä¼˜å…ˆæ›´æ–°è®¢é˜…: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin ${{ github.ref_name }} --force
            echo "âœ… s1.txtå·²æ›´æ–°å¹¶æ¨é€ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰"
          else
            echo "â„¹ï¸  s1.txtæ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          fi

      # ========== ç¬¬ä¸‰æ­¥ï¼šè½¬æ¢V2è®¢é˜…ä¸ºClashé…ç½®ï¼ˆåŸç¬¬ä¸€ä¸ªYAMLçš„æ ¸å¿ƒé€»è¾‘ï¼‰ ==========
      - name: å¯åŠ¨SubConverteræœåŠ¡
        run: |
          docker run -d -p 25500:25500 tindy2013/subconverter
          sleep 10  # å»¶é•¿ç­‰å¾…ï¼Œç¡®ä¿æœåŠ¡å°±ç»ª
          curl -I http://localhost:25500/sub || echo "âŒ SubConverteræœåŠ¡å¯åŠ¨å¤±è´¥"

      - name: è½¬æ¢3ä¸ªV2è®¢é˜…ä¸ºClashé…ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨æœ€æ–°s1.txtï¼‰
        run: |
          # å®šä¹‰3ä¸ªè®¢é˜…åœ°å€ï¼ˆæ­¤æ—¶s1.txtå·²æ›´æ–°ï¼Œå¯¹åº”V2_URL1æ˜¯æœ€æ–°çš„ï¼‰
          V2_URL="https://raw.githubusercontent.com/1013608955/mkdy/main/s.txt"
          V2_URL1="https://raw.githubusercontent.com/1013608955/mkdy/main/s1.txt"
          V2_URL2="https://raw.githubusercontent.com/1013608955/mkdy/main/s2.txt"

          # éªŒè¯è®¢é˜…åœ°å€æœ‰æ•ˆæ€§ï¼ˆç¡®ä¿æ‹‰å–çš„æ˜¯æœ€æ–°å†…å®¹ï¼‰
          echo "ğŸ” éªŒè¯è®¢é˜…åœ°å€æœ‰æ•ˆæ€§ï¼š"
          for url in "$V2_URL" "$V2_URL1" "$V2_URL2"; do
            status_code=$(curl -s --head "$url" -L | grep -i "^http" | awk '{print $2}')
            if [ "$status_code" = "200" ]; then
              echo "âœ… $url åœ°å€æœ‰æ•ˆï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰"
            else
              echo "âŒ $url åœ°å€æ— æ•ˆï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰ï¼Œé€€å‡ºè„šæœ¬"
              exit 1
            fi
          done

          # ç”ŸæˆClashé…ç½®æ–‡ä»¶ï¼ˆå¸¦è¶…æ—¶+é‡è¯•ï¼‰
          echo "ğŸ“ å¼€å§‹ç”ŸæˆClashé…ç½®æ–‡ä»¶ï¼š"
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s-clash.yaml
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL1&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s1-clash.yaml
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL2&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s2-clash.yaml

          # éªŒè¯é…ç½®æ–‡ä»¶ç”Ÿæˆï¼ˆéç©ºæ£€æŸ¥ï¼‰
          echo "ğŸ“‚ ç”Ÿæˆçš„é…ç½®æ–‡ä»¶è¯¦æƒ…ï¼š"
          for file in ./s-clash.yaml ./s1-clash.yaml ./s2-clash.yaml; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | awk '{print $1}')
              echo "âœ… $file å·²ç”Ÿæˆï¼Œå¤§å°ï¼š$size"
              if [ "$(stat -c%s "$file")" -eq 0 ]; then
                echo "âŒ $file å†…å®¹ä¸ºç©ºï¼Œè½¬æ¢å¤±è´¥"
                exit 1
              fi
            else
              echo "âŒ $file æœªç”Ÿæˆ"
              exit 1
            fi
          done

      # ========== ç¬¬å››æ­¥ï¼šæ¨é€Clashé…ç½®æ–‡ä»¶åˆ°ä»“åº“ ==========
      - name: æäº¤å¹¶æ¨é€Clashé…ç½®æ–‡ä»¶
        run: |
          # æ˜¾å¼æ·»åŠ æ‰€æœ‰é…ç½®æ–‡ä»¶ï¼ˆæ–°å¢/ä¿®æ”¹éƒ½åŒ…å«ï¼‰
          git add s-clash.yaml s1-clash.yaml s2-clash.yaml
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # æäº¤ï¼ˆæ— å˜æ›´åˆ™è·³è¿‡ï¼Œé¿å…æŠ¥é”™ï¼‰
          git commit -m "Auto update Clash config ${{ github.run_at }}" || echo "âœ… Clashé…ç½®æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          # å¼ºåˆ¶æ¨é€ï¼ˆç¡®ä¿æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶ç”Ÿæ•ˆï¼‰
          git push origin ${{ github.ref_name }} --force
          echo "âœ… Clashé…ç½®æ–‡ä»¶å·²æ¨é€ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰"
