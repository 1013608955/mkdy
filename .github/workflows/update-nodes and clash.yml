name: èŠ‚ç‚¹æ›´æ–° + Clashé…ç½®è½¬æ¢ï¼ˆæ¯1å°æ—¶ï¼‰

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:       # ä¿ç•™æ‰‹åŠ¨è§¦å‘

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆä¾¿äºç»´æŠ¤ï¼‰
env:
  REPO_NAME: mkdy                          # ä»“åº“å
  WORK_DIR: /home/runner/work/${{ env.REPO_NAME }}/${{ env.REPO_NAME }}  # Actionså·¥ä½œç›®å½•
  SUB_CONTAINER_NAME: subconverter-temp    # ä¸´æ—¶å®¹å™¨å
  GIT_USER_NAME: github-actions[bot]
  GIT_USER_EMAIL: github-actions[bot]@users.noreply.github.com

jobs:
  update-and-convert:
    runs-on: ubuntu-latest
    timeout-minutes: 8  # ç²¾å‡†è®¾ç½®è¶…æ—¶ï¼ˆä¼˜åŒ–åæµç¨‹â‰¤5åˆ†é’Ÿï¼‰
    steps:
      # ========== ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç ï¼ˆå¸¦PATæƒé™ï¼‰ ==========
      - name: ğŸ” æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true
          fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°æäº¤ï¼Œæå‡é€Ÿåº¦

      # ========== ç¬¬äºŒæ­¥ï¼šæ›´æ–°s1.txtï¼ˆèŠ‚ç‚¹æ›´æ–°ï¼‰ ==========
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'  # ç¼“å­˜pipä¾èµ–ï¼Œé¿å…é‡å¤å®‰è£…

      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          set -euo pipefail  # å¼€å¯ä¸¥æ ¼æ¨¡å¼ï¼Œæ•è·é”™è¯¯
          pip install --upgrade pip
          pip install requests
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') Pythonä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸš€ è¿è¡ŒèŠ‚ç‚¹æ›´æ–°è„šæœ¬
        run: |
          set -euo pipefail
          if [ ! -f "update_nodes.py" ]; then
            echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') update_nodes.pyæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') å¼€å§‹è¿è¡ŒèŠ‚ç‚¹æ›´æ–°è„šæœ¬..."
          python update_nodes.py
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') èŠ‚ç‚¹æ›´æ–°è„šæœ¬è¿è¡Œå®Œæˆ"
        env:
          PYTHONUNBUFFERED: "1"

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ–°åçš„s1.txt
        run: |
          set -euo pipefail
          # ä»…å½“å‰ä»“åº“é…ç½®gitç”¨æˆ·ï¼ˆé¿å…å…¨å±€æ±¡æŸ“ï¼‰
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"
          # å…ˆæ‹‰å–æœ€æ–°ä»£ç ï¼Œé¿å…å†²çª
          git pull origin ${{ github.ref_name }} --rebase
          # æ£€æŸ¥s1.txtæ˜¯å¦æœ‰å˜æ›´
          if [ -f s1.txt ] && [ $(git diff --name-only s1.txt | wc -l) -gt 0 ]; then
            git add s1.txt
            git commit -m "å¤šæ¥æº+Realityä¼˜å…ˆæ›´æ–°è®¢é˜…: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin ${{ github.ref_name }}
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') âœ… s1.txtå·²æ›´æ–°å¹¶æ¨é€ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰"
          else
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') â„¹ï¸  s1.txtæ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          fi

      # ========== ç¬¬ä¸‰æ­¥ï¼šè½¬æ¢Clashé…ç½®ï¼ˆä½¿ç”¨æœ¬åœ°æœ€æ–°s1.txtï¼‰ ==========
      - name: ğŸ³ å¯åŠ¨SubConverteræœåŠ¡ï¼ˆå¸¦çŠ¶æ€æ£€æŸ¥ï¼‰
        run: |
          set -euo pipefail
          # åœæ­¢å¹¶åˆ é™¤æ®‹ç•™å®¹å™¨ï¼ˆé¿å…ç«¯å£å ç”¨ï¼‰
          docker rm -f ${{ env.SUB_CONTAINER_NAME }} 2>/dev/null || true
          # å¯åŠ¨å®¹å™¨ï¼ˆæŒ‡å®šåç§°ï¼Œä¾¿äºåç»­æ¸…ç†ï¼‰
          docker run -d --name ${{ env.SUB_CONTAINER_NAME }} -p 25500:25500 tindy2013/subconverter
          sleep 5  # ç¼©çŸ­ç­‰å¾…ï¼ˆä¼˜åŒ–åæ— éœ€10ç§’ï¼‰
          # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
          if ! docker ps | grep -q ${{ env.SUB_CONTAINER_NAME }}; then
            echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') SubConverterå®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi
          # æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯ç”¨
          for i in {1..3}; do
            if curl -s -I http://localhost:25500/sub | grep -q "200 OK"; then
              echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') SubConverteræœåŠ¡å¯åŠ¨æˆåŠŸ"
              break
            fi
            echo "[WARN] $(date +'%Y-%m-%d %H:%M:%S') SubConverteræœåŠ¡æœªå°±ç»ªï¼Œç¬¬$iæ¬¡é‡è¯•..."
            sleep 2
            if [ $i -eq 3 ]; then
              echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') SubConverteræœåŠ¡å¯åŠ¨è¶…æ—¶ï¼Œç»ˆæ­¢æµç¨‹"
              exit 1
            fi
          done

      - name: ğŸ”„ è½¬æ¢V2è®¢é˜…ä¸ºClashé…ç½®ï¼ˆæœ¬åœ°æ–‡ä»¶ä¼˜å…ˆï¼‰
        run: |
          set -euo pipefail
          # å®šä¹‰è®¢é˜…åœ°å€ï¼ˆs1.txtç”¨æœ¬åœ°è·¯å¾„ï¼Œé¿å…ç½‘ç»œä¾èµ–ï¼‰
          V2_URL="https://raw.githubusercontent.com/1013608955/${{ env.REPO_NAME }}/main/s.txt"
          V2_URL1="file://${{ env.WORK_DIR }}/s1.txt"  # æœ¬åœ°æœ€æ–°s1.txt
          V2_URL2="https://raw.githubusercontent.com/1013608955/${{ env.REPO_NAME }}/main/s2.txt"

          # éªŒè¯è®¢é˜…åœ°å€ï¼ˆå¸¦3æ¬¡é‡è¯•ï¼‰
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') å¼€å§‹éªŒè¯è®¢é˜…åœ°å€..."
          validate_url() {
            local url=$1
            local retry=3
            for i in {1..$retry}; do
              status_code=$(curl -s --head "$url" -L | grep -i "^http" | awk '{print $2}')
              if [ "$status_code" = "200" ] || [[ "$url" == file://* ]]; then
                echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') âœ… $url åœ°å€æœ‰æ•ˆ"
                return 0
              fi
              echo "[WARN] $(date +'%Y-%m-%d %H:%M:%S') $url åœ°å€æ— æ•ˆï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰ï¼Œç¬¬$iæ¬¡é‡è¯•..."
              sleep 2
              if [ $i -eq $retry ]; then
                echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') âŒ $url åœ°å€éªŒè¯å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
                return 1
              fi
            done
          }
          # æ‰¹é‡éªŒè¯
          for url in "$V2_URL" "$V2_URL1" "$V2_URL2"; do
            validate_url "$url" || exit 1
          done

          # ç”ŸæˆClashé…ç½®ï¼ˆå¸¦è¶…æ—¶+é‡è¯•ï¼‰
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') å¼€å§‹ç”ŸæˆClashé…ç½®æ–‡ä»¶..."
          generate_config() {
            local url=$1
            local output=$2
            curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$url&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o "$output"
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦éç©º
            if [ "$(stat -c%s "$output")" -eq 0 ]; then
              echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') âŒ $output å†…å®¹ä¸ºç©ºï¼Œè½¬æ¢å¤±è´¥"
              exit 1
            fi
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') âœ… $output ç”ŸæˆæˆåŠŸï¼Œå¤§å°ï¼š$(du -h "$output" | awk '{print $1}')"
          }
          # æ‰¹é‡ç”Ÿæˆ
          generate_config "$V2_URL" "./s-clash.yaml"
          generate_config "$V2_URL1" "./s1-clash.yaml"
          generate_config "$V2_URL2" "./s2-clash.yaml"

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€Clashé…ç½®æ–‡ä»¶ï¼ˆä»…å˜æ›´æ—¶æ¨é€ï¼‰
        run: |
          set -euo pipefail
          # ä»…å½“å‰ä»“åº“é…ç½®gitç”¨æˆ·
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"
          # å…ˆæ‹‰å–æœ€æ–°ä»£ç 
          git pull origin ${{ github.ref_name }} --rebase
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰å˜æ›´
          git add s-clash.yaml s1-clash.yaml s2-clash.yaml
          if git diff --cached --quiet; then
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') â„¹ï¸  Clashé…ç½®æ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "Auto update Clash config: ${{ github.run_at }}"
            git push origin ${{ github.ref_name }}
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') âœ… Clashé…ç½®æ–‡ä»¶å·²æ¨é€ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰"
          fi

      # ========== æ”¶å°¾ï¼šæ¸…ç†èµ„æº ==========
      - name: ğŸ§¹ æ¸…ç†SubConverterå®¹å™¨
        if: always()  # æ— è®ºå‰é¢æ­¥éª¤æ˜¯å¦å¤±è´¥ï¼Œéƒ½æ‰§è¡Œæ¸…ç†
        run: |
          docker rm -f ${{ env.SUB_CONTAINER_NAME }} 2>/dev/null || true
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') SubConverterå®¹å™¨å·²æ¸…ç†"
