name: 每天自动更新免费节点

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 0点（北京时间早上8点）
  workflow_dispatch:  # 支持手动一键触发

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 安装依赖
        run: pip install requests

      - name: 拉取并过滤节点
        run: |
          python << 'EOF'
          import requests
          import re
          import subprocess
          import time
          import base64

          # 活跃来源（2025年12月确认有效，明文每行一个链接为主）
          sources = [
              "https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/main/all_extracted_configs.txt",  # 主力：5000+节点，每30分钟更新
              "https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub",  # Base64格式，直接保留
              "https://raw.githubusercontent.com/barry-far/V2ray-Config/main/Splitted-By-Protocol/vmess.txt",  # barry-far新路径（如果可用）
              "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/Sub.txt",  # Epodonios聚合订阅
              "https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/Eternity.txt",  # 另一个经典聚合
          ]

          valid_lines = []

          for url in sources:
              try:
                  resp = requests.get(url, timeout=30)
                  resp.raise_for_status()
                  content = resp.text.strip()
                  print(f"从 {url} 拉取成功")

                  # 特殊处理Base64订阅（单行或多行Base64）
                  if 'Pawdroid' in url or len(content.split('\n')) <= 5 or not content.startswith(('vmess://', 'vless://', 'trojan://', 'ss://')):
                      # 假设是Base64，整块添加（v2rayN支持直接Base64订阅）
                      valid_lines.append(content)  # 添加整内容，或解码后split
                      print("Base64格式，直接保留")
                      continue

                  lines = content.split('\n')
                  print(f"共 {len(lines)} 条明文节点")

                  for line in lines:
                      line = line.strip()
                      if not line or line.startswith('#'):
                          continue

                      # 对于vmess://如果是Base64编码的，先尝试解码成标准链接
                      if line.startswith('vmess://'):
                          try:
                              decoded = base64.b64decode(line[8:]).decode('utf-8')
                              if decoded.startswith('{'):
                                  # 是json vmess，保留原样
                                  pass
                          except:
                              pass

                      # 提取IP（常见格式：@ip:port 或 host=ip）
                      ip = None
                      ip_match = re.search(r'@([\d\.]+):', line) or re.search(r'host=([\d\.]+)', line) or re.search(r':([\d\.]+):', line)
                      if ip_match:
                          ip = ip_match.group(1)

                      if not ip:
                          valid_lines.append(line)  # 无IP，保留（可能是域名或Base64）
                          continue

                      # ping 测试
                      try:
                          result = subprocess.run(['ping', '-c', '3', '-W', '2', ip],
                                                  stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                          if result.returncode == 0:
                              valid_lines.append(line)
                              print(f"可用: {ip}")
                          else:
                              print(f"不可用: {ip}")
                      except:
                          print(f"ping失败: {ip}")

                      time.sleep(0.3)  # 防太快

              except Exception as e:
                  print(f"拉取 {url} 失败: {e}")

          # 去重（保留顺序）
          unique_lines = []
          seen = set()
          for line in valid_lines:
              if line not in seen:
                  seen.add(line)
                  unique_lines.append(line)

          # 写入 s1.txt
          with open('s1.txt', 'w', encoding='utf-8') as f:
              f.write('\n'.join(unique_lines) + '\n')

          print(f"最终保留 {len(unique_lines)} 条节点")
          EOF

      - name: Commit 并推送更新
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add s1.txt
          if git diff --staged --quiet; then
              echo "无变化，不提交"
          else
              git commit -m "自动更新节点: $(date +'%Y-%m-%d')"
              git push
          fi
