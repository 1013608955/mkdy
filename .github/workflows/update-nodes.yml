name: 每天自动更新免费节点（Base64输出 + IP去重）

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 0点（北京时间早上8点）
  workflow_dispatch:  # 支持手动一键触发

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 安装依赖
        run: pip install requests

      - name: 拉取、过滤、IP去重并Base64编码
        run: |
          python << 'EOF'
          import requests
          import re
          import subprocess
          import time
          import base64
          import json

          # 2025年活跃高质量来源（明文每行一个链接）
          sources = [
              "https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/main/all_extracted_configs.txt",  # 主力，每30分钟更新
              "https://raw.githubusercontent.com/barry-far/V2ray-Configs/main/All_Configs_Sub.txt",  # 每10分钟更新，大量节点
              "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt",  # 每5分钟更新
              "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/super-sub.txt",  # 聚合
          ]

          valid_lines = []
          seen_ips = set()  # IP去重

          for url in sources:
              try:
                  resp = requests.get(url, timeout=30)
                  resp.raise_for_status()
                  content = resp.text.strip()
                  print(f"从 {url} 拉取成功")

                  lines = [line.strip() for line in content.split('\n') if line.strip() and not line.startswith('#')]

                  for line in lines:
                      ip = None

                      # 处理 vmess:// Base64解码提取IP
                      if line.startswith('vmess://'):
                          try:
                              decoded = base64.b64decode(line[8:] + '==').decode('utf-8', errors='ignore')
                              config = json.loads(decoded)
                              ip = config.get('add') or config.get('host')
                          except:
                              pass

                      # 其他协议提取IP
                      if not ip:
                          ip_match = (re.search(r'@([\d\.]+):', line) or
                                      re.search(r'host=([\d\.]+)', line) or
                                      re.search(r':([\d\.]+):', line))
                          if ip_match:
                              ip = ip_match.group(1)

                      # 无IP或域名节点：直接保留（不去重）
                      if not ip or not re.match(r'^\d{1,3}(\.\d{1,3}){3}$', ip):
                          if line not in valid_lines:
                              valid_lines.append(line)
                          continue

                      # IP去重：只保留第一个
                      if ip in seen_ips:
                          print(f"重复IP丢弃: {ip}")
                          continue
                      seen_ips.add(ip)

                      # ping过滤（2次，超时2秒）
                      try:
                          result = subprocess.run(['ping', '-c', '2', '-W', '2', ip],
                                                  stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                          if result.returncode == 0:
                              valid_lines.append(line)
                              print(f"可用保留: {ip}")
                          else:
                              print(f"不可用丢弃: {ip}")
                      except:
                          print(f"ping失败丢弃: {ip}")

                      time.sleep(0.2)

              except Exception as e:
                  print(f"拉取 {url} 失败: {e}")

          # 最终：连接所有节点 + Base64编码
          combined = '\n'.join(valid_lines)
          base64_encoded = base64.b64encode(combined.encode('utf-8')).decode('utf-8')

          # 写入 s1.txt（单个Base64字符串）
          with open('s1.txt', 'w', encoding='utf-8') as f:
              f.write(base64_encoded)

          print(f"最终处理完成：{len(valid_lines)} 条唯一IP节点 → Base64编码保存")
          EOF

      - name: Commit 并推送更新
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add s1.txt
          if git diff --staged --quiet; then
              echo "无变化，不提交"
          else
              git commit -m "自动更新Base64订阅: $(date +'%Y-%m-%d')"
              git push
          fi
