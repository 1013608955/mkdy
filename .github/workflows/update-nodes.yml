name: 极致多线程更新免费节点（TCP + Base64）

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 安装 requests
        run: pip install requests

      - name: 多线程拉取、去重、TCP测试 + Base64
        run: |
          python << 'EOF'
          import requests
          import re
          import socket
          import time
          import base64
          import json
          from concurrent.futures import ThreadPoolExecutor, as_completed

          sources = [
              "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt",
              "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/super-sub.txt",
          ]

          all_lines = set()
          for url in sources:
              try:
                  resp = requests.get(url, timeout=40)
                  resp.raise_for_status()
                  for line in resp.text.split('\n'):
                      l = line.strip()
                      if l and not l.startswith('#'):
                          all_lines.add(l)
              except Exception as e:
                  print(f"拉取失败 {url}: {e}")

          unique_lines = list(all_lines)
          print(f"全局去重后：{len(unique_lines)} 条")

          def test_node(line):
              host = ip = None
              port = 443
              port_match = re.search(r':(\d+)', line)
              if port_match:
                  port = int(port_match.group(1))

              if line.startswith('vmess://'):
                  try:
                      decoded = base64.b64decode(line[8:] + '==').decode('utf-8', errors='ignore')
                      cfg = json.loads(decoded)
                      host = cfg.get('add') or cfg.get('host')
                      port = cfg.get('port', 443)
                  except:
                      return line  # vmess失败直接保留

              if not host:
                  match = re.search(r'@([^:]+):|host=([^&]+)', line)
                  if match:
                      host = next((g for g in match.groups() if g), None)

              if host and re.match(r'^\d{1,3}(\.\d{1,3}){3}$', host):
                  ip = host

              if not ip:
                  return line  # 域名直接保留

              try:
                  sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                  sock.settimeout(1)
                  result = sock.connect_ex((ip, port))
                  sock.close()
                  if result == 0:
                      return line
              except:
                  pass
              return None

          valid_lines = []
          seen_ips = set()

          with ThreadPoolExecutor(max_workers=20) as executor:
              future_to_line = {executor.submit(test_node, line): line for line in unique_lines}
              for future in as_completed(future_to_line):
                  result = future.result()
                  if result:
                      # IP去重
                      # 快速提取ip（重复代码简略）
                      ip_match = re.search(r'@([\d\.]+):|add":"([\d\.]+)', result)  # 简化
                      ip = ip_match.group(1) or ip_match.group(2) if ip_match else None
                      if ip and ip in seen_ips:
                          continue
                      if ip:
                          seen_ips.add(ip)
                      valid_lines.append(result)

          combined = '\n'.join(valid_lines)
          encoded = base64.b64encode(combined.encode('utf-8')).decode('utf-8')

          with open('s1.txt', 'w') as f:
              f.write(encoded)

          print(f"最终独特可用节点：{len(valid_lines)} 条")
          EOF

      - name: Commit 更新
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add s1.txt
          git diff --staged --quiet || git commit -m "多线程极致更新: $(date +'%Y-%m-%d')"
          git push
