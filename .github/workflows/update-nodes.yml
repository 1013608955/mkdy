name: 极致免费节点更新（多来源 + 域名去重 + Reality/TLS优先 + 每1小时）

on:
  schedule:
    - cron: '0 */1 * * *'  # 每3小时执行一次，如需调整：每1小时→0 */1 * * *，每天→0 0 * * *
  workflow_dispatch:  # 保留手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 100  # 缩短超时时间（移除V2Ray后脚本运行≤3分钟）
    steps:
      - name: Checkout代码
        uses: actions/checkout@v4

      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 安装Python依赖
        run: pip install requests

      - name: 运行节点更新脚本
        run: python update_nodes.py
        env:
          PYTHONUNBUFFERED: "1"  # 实时输出日志，方便排查

      - name: 提交并推送结果
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # 仅当s1.txt有变更时提交
          if [ -f s1.txt ] && [ $(git diff --name-only s1.txt | wc -l) -gt 0 ]; then
            git add s1.txt
            git commit -m "多来源+Reality优先更新订阅: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "✅ 订阅文件已更新并推送"
          else
            echo "ℹ️  无节点更新，跳过提交"
          fi
