name: 加强版极致免费节点更新（域名去重 + TCP + Base64）

on:
  schedule:
    - cron: '0 */4 * * *'  # 每4小时一次，可改 */3 为每3小时
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 安装 requests
        run: pip install requests

      - name: 加强去重、TCP测试 + Base64
        run: |
          python << 'EOF'
          import requests
          import re
          import socket
          import time
          import base64
          import json

          sources = [
              "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt",
              "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/super-sub.txt",
          ]

          all_lines = set()
          for url in sources:
              try:
                  resp = requests.get(url, timeout=40)
                  resp.raise_for_status()
                  for line in resp.text.split('\n'):
                      l = line.strip()
                      if l and not l.startswith('#'):
                          all_lines.add(l)
              except Exception as e:
                  print(f"拉取失败 {url}: {e}")

          unique_lines = list(all_lines)
          print(f"全局字符串去重后：{len(unique_lines)} 条")

          valid_lines = []
          seen_ips = set()
          seen_domains = set()  # 新增：域名/SNI去重

          def extract_ip_and_domain(line):
              ip = domain = port = None
              port = 443

              port_match = re.search(r':(\d+)', line)
              if port_match:
                  port = int(port_match.group(1))

              if line.startswith('vmess://'):
                  try:
                      decoded = base64.b64decode(line[8:] + '==').decode('utf-8', errors='ignore')
                      cfg = json.loads(decoded)
                      ip = cfg.get('add')
                      domain = cfg.get('host') or cfg.get('sni') or cfg.get('tls')
                      port = cfg.get('port', 443)
                  except:
                      pass

              # 提取明文IP和域名/SNI
              ip_match = re.search(r'@([\d\.]+):', line)
              if ip_match:
                  ip = ip_match.group(1)

              # 提取域名/SNI（常见参数：sni=、host=、peer=等）
              domain_match = re.search(r'sni=([^&]+)|host=([^&]+)|peer=([^&]+)', line, re.IGNORECASE)
              if domain_match:
                  domain = next((g for g in domain_match.groups() if g), None)

              return ip, domain or "", port

          for line in unique_lines:
              ip, domain, port = extract_ip_and_domain(line)

              # 域名去重（优先）
              if domain and domain in seen_domains:
                  continue
              if domain:
                  seen_domains.add(domain)

              # IP去重
              if ip and ip in seen_ips:
                  continue
              if ip:
                  seen_ips.add(ip)

              # TCP测试
              test_ip = ip if ip else None
              if not test_ip and domain:
                  try:
                      test_ip = socket.gethostbyname(domain)  # 域名解析为IP测试（可选，慢时可注释）
                  except:
                      test_ip = None

              if test_ip:
                  try:
                      sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                      sock.settimeout(1)
                      result = sock.connect_ex((test_ip, port))
                      sock.close()
                      if result != 0:
                          continue  # TCP不通丢弃
                  except:
                      continue  # 测试失败丢弃

              # 通过所有过滤，保留
              valid_lines.append(line)

          combined = '\n'.join(valid_lines)
          encoded = base64.b64encode(combined.encode('utf-8')).decode('utf-8')

          with open('s1.txt', 'w') as f:
              f.write(encoded)

          print(f"最终独特可用节点：{len(valid_lines)} 条（独特IP {len(seen_ips)} + 独特域名 {len(seen_domains)}）")
          EOF

      - name: Commit 并推送
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add s1.txt
          git diff --staged --quiet || git commit -m "加强域名去重更新订阅: $(date +'%Y-%m-%d')"
          git push
