name: 每天自动更新免费节点（快速版 + 彻底去重 + Base64）

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # 加这个防超6小时
    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 安装依赖
        run: pip install requests

      - name: 快速拉取、去重并Base64
        run: |
          python << 'EOF'
          import requests
          import re
          import subprocess
          import time
          import base64
          import json

          # 2025年12月活跃来源（节点适中，高质量）
          sources = [
              "https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/main/all_extracted_configs.txt",  # 主力，几千条，每30分钟
              "https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt",  # 每5分钟
              "https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/super-sub.txt",  # 每15分钟，优质聚合
          ]

          valid_lines = []
          seen_ips = set()
          seen_lines = set()

          for url in sources:
              try:
                  resp = requests.get(url, timeout=30)
                  resp.raise_for_status()
                  lines = [l.strip() for l in resp.text.split('\n') if l.strip() and not l.startswith('#')]

                  for line in lines:
                      if line in seen_lines:
                          continue

                      host = None
                      ip = None

                      if line.startswith('vmess://'):
                          try:
                              decoded = base64.b64decode(line[8:] + '==').decode('utf-8', errors='ignore')
                              config = json.loads(decoded)
                              host = config.get('add') or config.get('host')
                          except:
                              pass

                      if not host:
                          match = re.search(r'@([^:]+):|host=([^&]+)', line)
                          if match:
                              host = next(g for g in match.groups() if g)

                      if host and re.match(r'^\d{1,3}(\.\d{1,3}){3}$', host):
                          ip = host

                      # 无IP（域名或复杂）：字符串去重保留
                      if not ip:
                          if line not in seen_lines:
                              valid_lines.append(line)
                              seen_lines.add(line)
                          continue

                      if ip in seen_ips:
                          print(f"重复IP丢弃: {ip}")
                          continue
                      seen_ips.add(ip)

                      # 快速ping（1次，超时1秒）
                      try:
                          result = subprocess.run(['ping', '-c', '1', '-W', '1', ip],
                                                  stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                          if result.returncode == 0:
                              valid_lines.append(line)
                              seen_lines.add(line)
                              print(f"保留: {ip}")
                          else:
                              print(f"不可用: {ip}")
                      except:
                          print(f"ping失败: {ip}")

                      time.sleep(0.1)  # 更小sleep

              except Exception as e:
                  print(f"来源失败: {e}")

          combined = '\n'.join(valid_lines)
          encoded = base64.b64encode(combined.encode('utf-8')).decode('utf-8')

          with open('s1.txt', 'w') as f:
              f.write(encoded)

          print(f"完成：{len(valid_lines)} 条（独特IP {len(seen_ips)} 个）")
          EOF

      - name: Commit 更新
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add s1.txt
          if git diff --staged --quiet; then
              echo "无变化"
          else
              git commit -m "快速更新Base64订阅: $(date +'%Y-%m-%d')"
              git push
          fi
