name: Auto Convert V2 to Clash Daily

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true

      - name: Start SubConverter Service
        run: |
          docker run -d -p 25500:25500 tindy2013/subconverter
          sleep 10
          curl -I http://localhost:25500/sub || echo "âŒ SubConverteræœåŠ¡å¯åŠ¨å¤±è´¥"

      - name: Convert V2 Subscription (3 addresses)
        run: |
          V2_URL="https://raw.githubusercontent.com/1013608955/mkdy/main/s.txt"
          V2_URL1="https://raw.githubusercontent.com/1013608955/mkdy/main/s1.txt"
          V2_URL2="https://raw.githubusercontent.com/1013608955/mkdy/main/s2.txt"

          # éªŒè¯è®¢é˜…åœ°å€
          echo "ğŸ” éªŒè¯è®¢é˜…åœ°å€æœ‰æ•ˆæ€§ï¼š"
          for url in "$V2_URL" "$V2_URL1" "$V2_URL2"; do
            status_code=$(curl -s --head "$url" -L | grep -i "^http" | awk '{print $2}')
            if [ "$status_code" = "200" ]; then
              echo "âœ… $url åœ°å€æœ‰æ•ˆï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰"
            else
              echo "âŒ $url åœ°å€æ— æ•ˆï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰ï¼Œé€€å‡ºè„šæœ¬"
              exit 1
            fi
          done

          # ç”Ÿæˆé…ç½®æ–‡ä»¶
          echo "ğŸ“ å¼€å§‹ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼š"
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s-clash.yaml
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL1&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s1-clash.yaml
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL2&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s2-clash.yaml

          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          echo "ğŸ“‚ ç”Ÿæˆçš„æ–‡ä»¶è¯¦æƒ…ï¼š"
          for file in ./s-clash.yaml ./s1-clash.yaml ./s2-clash.yaml; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | awk '{print $1}')
              echo "âœ… $file å·²ç”Ÿæˆï¼Œå¤§å°ï¼š$size"
              if [ "$(stat -c%s "$file")" -eq 0 ]; then
                echo "âŒ $file å†…å®¹ä¸ºç©ºï¼Œè½¬æ¢å¤±è´¥"
                exit 1
              fi
            else
              echo "âŒ $file æœªç”Ÿæˆ"
              exit 1
            fi
          done

      # æ›¿æ¢åŸæ’ä»¶æ­¥éª¤ï¼Œç”¨åŸç”Ÿgitå‘½ä»¤æäº¤æ¨é€
      - name: Save Config to Repository
        run: |
          # æ˜¾å¼æ·»åŠ æ‰€æœ‰ç›®æ ‡æ–‡ä»¶ï¼ˆæ–°å¢/ä¿®æ”¹éƒ½åŒ…å«ï¼‰
          git add s-clash.yaml s1-clash.yaml s2-clash.yaml
          # é…ç½®gitç”¨æˆ·ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # æäº¤ï¼ˆæ— å˜æ›´åˆ™è·³è¿‡ï¼‰
          git commit -m "Auto update Clash config ${{ github.run_at }}" || echo "âœ… æ— å˜æ›´æ— éœ€æäº¤"
          # å¼ºåˆ¶æ¨é€ï¼ˆç¡®ä¿æ–°å¢æ–‡ä»¶è¢«æ¨é€åˆ°ä»“åº“ï¼‰
          git push origin ${{ github.ref_name }} --force
