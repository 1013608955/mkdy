name: Auto Convert V2 to Clash Daily

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©UTC1ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´9ç‚¹ï¼‰è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ï¼ˆç”¨PATä»¤ç‰Œè·å–æ¨é€æƒé™ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true

      # æ­¥éª¤2ï¼šå¯åŠ¨SubConverteræœåŠ¡
      - name: Start SubConverter Service
        run: |
          docker run -d -p 25500:25500 tindy2013/subconverter
          sleep 5  # ç­‰å¾…æœåŠ¡å¯åŠ¨

      # æ­¥éª¤3ï¼šè½¬æ¢3ä¸ªV2è®¢é˜…ä¸ºå¯¹åº”çš„Clashé…ç½®æ–‡ä»¶
      - name: Convert V2 Subscription (3 addresses)
        run: |
          # å®šä¹‰3ä¸ªV2è®¢é˜…åœ°å€
          V2_URL="https://raw.githubusercontent.com/1013608955/mkdy/main/s.txt"
          V2_URL1="https://raw.githubusercontent.com/1013608955/mkdy/main/s1.txt"
          V2_URL2="https://raw.githubusercontent.com/1013608955/mkdy/main/s2.txt"

          # ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼ˆæ˜ç¡®æŒ‡å®šç”Ÿæˆåˆ°ä»“åº“æ ¹ç›®å½•ï¼‰
          curl "http://localhost:25500/sub?target=clash&url=$V2_URL&group=Auto&interval=60&url_test=https://www.google.com/generate_204" -o ./s-clash.yaml
          curl "http://localhost:25500/sub?target=clash&url=$V2_URL1&group=Auto&interval=60&url_test=https://www.google.com/generate_204" -o ./s1-clash.yaml
          curl "http://localhost:25500/sub?target=clash&url=$V2_URL2&group=Auto&interval=60&url_test=https://www.google.com/generate_204" -o ./s2-clash.yaml

          # éªŒè¯æ–‡ä»¶+æ‰“å°æ–‡ä»¶åˆ—è¡¨ï¼ˆæ–°å¢ï¼šæ’æŸ¥æ–‡ä»¶æ˜¯å¦çœŸçš„å­˜åœ¨ï¼‰
          echo "ğŸ“‚ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -l ./s-clash.yaml ./s1-clash.yaml ./s2-clash.yaml
          if [ -f "./s-clash.yaml" ] && [ -f "./s1-clash.yaml" ] && [ -f "./s2-clash.yaml" ]; then
            echo "âœ… ä¸‰ä¸ªé…ç½®æ–‡ä»¶éƒ½ç”ŸæˆæˆåŠŸ"
          else
            echo "âŒ éƒ¨åˆ†é…ç½®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      # æ­¥éª¤4ï¼šæ¨é€æ‰€æœ‰é…ç½®æ–‡ä»¶åˆ°ä»“åº“ï¼ˆä¿®å¤æ–‡ä»¶åŒ¹é…+ç®€åŒ–æäº¤å‚æ•°ï¼‰
      - name: Save Config to Repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto update Clash config $(date +'%Y-%m-%d_%H-%M-%S')"  # æ›¿æ¢:ä¸º_ï¼Œé¿å…å­—ç¬¦å†²çª
          file_pattern: |  # ç”¨åˆ†è¡Œæ ¼å¼ï¼Œé¿å…é€—å·æ‹¼æ¥é”™è¯¯
            s-clash.yaml
            s1-clash.yaml
            s2-clash.yaml
          branch: ${{ github.ref_name }}
          push_options: '--force'
          commit_options: '--allow-empty'
          skip_dirty_check: true
