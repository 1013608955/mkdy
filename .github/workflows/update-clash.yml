name: Auto Convert V2 to Clash Daily

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true

      - name: Start SubConverter Service
        run: |
          docker run -d -p 25500:25500 tindy2013/subconverter
          sleep 10  # å»¶é•¿å¯åŠ¨ç­‰å¾…æ—¶é—´ï¼Œç¡®ä¿æœåŠ¡å°±ç»ª
          # éªŒè¯SubConverteræœåŠ¡æ˜¯å¦å¯åŠ¨
          curl -I http://localhost:25500/sub || echo "âŒ SubConverteræœåŠ¡å¯åŠ¨å¤±è´¥"

      - name: Convert V2 Subscription (3 addresses)
        run: |
          # å®šä¹‰3ä¸ªè®¢é˜…åœ°å€ï¼ˆæ›¿æ¢ä¸ºä½ å®é™…æœ‰æ•ˆåœ°å€ï¼‰
          V2_URL="https://raw.githubusercontent.com/1013608955/mkdy/main/s.txt"
          V2_URL1="https://raw.githubusercontent.com/1013608955/mkdy/main/s1.txt"
          V2_URL2="https://raw.githubusercontent.com/1013608955/mkdy/main/s2.txt"

          # 1. å…ˆéªŒè¯è®¢é˜…åœ°å€æ˜¯å¦æœ‰æ•ˆ
          echo "ğŸ” éªŒè¯è®¢é˜…åœ°å€æœ‰æ•ˆæ€§ï¼š"
          for url in "$V2_URL" "$V2_URL1" "$V2_URL2"; do
            if curl -s --head "$url" | grep -q "200 OK"; then
              echo "âœ… $url åœ°å€æœ‰æ•ˆ"
            else
              echo "âŒ $url åœ°å€æ— æ•ˆï¼Œé€€å‡ºè„šæœ¬"
              exit 1
            fi
          done

          # 2. ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼ˆæ·»åŠ é‡è¯•+è¶…æ—¶ï¼‰
          echo "ğŸ“ å¼€å§‹ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼š"
          # ç”Ÿæˆs-clash.yaml
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s-clash.yaml
          # ç”Ÿæˆs1-clash.yaml
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL1&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s1-clash.yaml
          # ç”Ÿæˆs2-clash.yaml
          curl --max-time 30 --retry 3 "http://localhost:25500/sub?target=clash&url=$V2_URL2&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" -o ./s2-clash.yaml

          # 3. å¼ºåˆ¶åˆ·æ–°æ–‡ä»¶æ—¶é—´æˆ³ï¼ˆç¡®ä¿gitè¯†åˆ«ä¸ºä¿®æ”¹ï¼‰
          touch ./s-clash.yaml ./s1-clash.yaml ./s2-clash.yaml

          # 4. éªŒè¯æ–‡ä»¶ç”Ÿæˆ+æ‰“å°æ–‡ä»¶å¤§å°ï¼ˆå…³é”®ï¼šå¤§å°ä¸º0åˆ™ç”Ÿæˆå¤±è´¥ï¼‰
          echo "ğŸ“‚ ç”Ÿæˆçš„æ–‡ä»¶è¯¦æƒ…ï¼š"
          for file in ./s-clash.yaml ./s1-clash.yaml ./s2-clash.yaml; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | awk '{print $1}')
              echo "âœ… $file å·²ç”Ÿæˆï¼Œå¤§å°ï¼š$size"
              # è‹¥æ–‡ä»¶å¤§å°ä¸º0ï¼Œè¯´æ˜è½¬æ¢å¤±è´¥
              if [ "$(stat -c%s "$file")" -eq 0 ]; then
                echo "âŒ $file å†…å®¹ä¸ºç©ºï¼Œè½¬æ¢å¤±è´¥"
                exit 1
              fi
            else
              echo "âŒ $file æœªç”Ÿæˆ"
              exit 1
            fi
          done

      - name: Save Config to Repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # ä¿®å¤dateå‘½ä»¤è§£æé—®é¢˜ï¼šç”¨envä¼ é€’æ—¶é—´æˆ³
          commit_message: "Auto update Clash config ${{ env.GITHUB_RUN_AT }}"
          file_pattern: |
            s-clash.yaml
            s1-clash.yaml
            s2-clash.yaml
          branch: ${{ github.ref_name }}
          push_options: '--force'
          commit_options: '--allow-empty'
          skip_dirty_check: true
        env:
          GITHUB_RUN_AT: ${{ github.run_at }}  # ä½¿ç”¨GitHubå†…ç½®æ—¶é—´æˆ³ï¼Œé¿å…shellè§£æé—®é¢˜
