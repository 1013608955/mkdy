name: 监控mukuidm.dpdns.org域名过期时间

on:
  schedule:
    - cron: '0 2 * * 0'  # 每周日UTC2点（国内10点）执行
  workflow_dispatch:     # 手动触发

jobs:
  check-domain-expiry:
    runs-on: ubuntu-latest
    steps:
      - name: 安装jq工具（仅用于URL编码）
        run: |
          sudo apt update
          sudo apt install -y jq

      - name: 执行过期检查（用已知过期时间）
        env:
          # 替换为你Uptime Kuma的正确基础Push URL
          PUSH_URL_BASE: "https://mkjk.zeabur.app/api/push/o62FOv"
          DOMAIN: "mukuidm.dpdns.org"
          # 已知过期时间（格式化为date命令可识别的形式）
          KNOWN_EXPIRY_DATE: "2026-12-27"
        run: |
          # 1. 计算剩余天数
          EXPIRY_TIMESTAMP=$(date -d "$KNOWN_EXPIRY_DATE" +%s)
          CURRENT_TIMESTAMP=$(date +%s)
          DAYS_UNTIL_EXPIRY=$(( (EXPIRY_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
          # 2. 判断告警状态
          if [ $DAYS_UNTIL_EXPIRY -lt 0 ]; then
            STATUS="down"
            MESSAGE="❌ 域名已过期！过期日期：$KNOWN_EXPIRY_DATE（已过期 $((-DAYS_UNTIL_EXPIRY)) 天）"
          elif [ $DAYS_UNTIL_EXPIRY -lt 30 ]; then
            STATUS="down"
            MESSAGE="⚠️ 域名即将过期！过期日期：$KNOWN_EXPIRY_DATE（剩余 $DAYS_UNTIL_EXPIRY 天）"
          else
            STATUS="up"
            MESSAGE="✅ 域名状态正常！过期日期：$KNOWN_EXPIRY_DATE（剩余 $DAYS_UNTIL_EXPIRY 天）"
          fi

          # 3. URL编码消息
          ENCODED_MSG=$(echo -n "$MESSAGE" | jq -s -R -r @uri)
          
          # 4. 推送到Uptime Kuma
          echo "推送内容：$MESSAGE"
          curl -X POST "${PUSH_URL_BASE}?status=${STATUS}&msg=${ENCODED_MSG}" \
            --connect-timeout 10 \
            --max-time 20 \
            -w "\n推送状态码：%{http_code}\n"
