# å»ºè®®å°†æ­¤æ–‡ä»¶å‘½åä¸ºï¼šupdate-nodes-and-clash.ymlï¼ˆæ— ç©ºæ ¼ï¼Œé¿å…è§£æé”™è¯¯ï¼‰
name: èŠ‚ç‚¹æ›´æ–° + Clashé…ç½®è½¬æ¢ï¼ˆæ¯1å°æ—¶ï¼‰

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼ˆå¦‚éœ€é™ä½é¢‘ç‡å¯æ”¹ä¸º0 */2 * * *ï¼‰
  workflow_dispatch:       # ä¿ç•™æ‰‹åŠ¨è§¦å‘
  # å¯é€‰ï¼šä»£ç æ¨é€æ—¶è§¦å‘ï¼Œä¾¿äºæµ‹è¯•
  push:
    paths:
      - 'update_nodes.py'
      - '.github/workflows/update-nodes-and-clash.yml'

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆæŠ½ç¦»æ˜“å˜é…ç½®ï¼Œä¾¿äºç»´æŠ¤ï¼‰
env:
  # å®¹å™¨é…ç½®
  SUB_CONTAINER_NAME: subconverter-temp
  SUB_CONTAINER_PORT: 25500
  # Gité…ç½®
  GIT_USER_NAME: github-actions[bot]
  GIT_USER_EMAIL: github-actions[bot]@users.noreply.github.com
  # è®¢é˜…é“¾æ¥ï¼ˆé›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹æ—¶åªéœ€æ”¹è¿™é‡Œï¼‰
  SUB_URL_S: https://raw.githubusercontent.com/1013608955/${{ github.event.repository.name }}/main/s.txt
  SUB_URL_S1: https://raw.githubusercontent.com/1013608955/${{ github.event.repository.name }}/main/s1.txt
  SUB_URL_S2: https://raw.githubusercontent.com/1013608955/${{ github.event.repository.name }}/main/s2.txt
  # è¶…æ—¶é…ç½®ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰
  CURL_TIMEOUT: 30
  CURL_RETRY: 3
  SERVICE_WAIT_SECONDS: 15  # å›ºå®šç­‰å¾…15ç§’

jobs:
  update-and-convert:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    # å…³é”®æ­¥éª¤å¤±è´¥åé‡è¯•1æ¬¡
    strategy:
      fail-fast: true
      matrix:
        retry: [1]
    steps:
      # ========== ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»“åº“ä»£ç  ==========
      - name: ğŸ” æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true
          fetch-depth: 1
        timeout-minutes: 2

      # ========== ç¬¬äºŒæ­¥ï¼šPythonç¯å¢ƒé…ç½®ï¼ˆå¯ç”¨ç¼“å­˜ï¼‰ ==========
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'  # é‡æ–°å¯ç”¨ç¼“å­˜ï¼Œæå‡ä¾èµ–å®‰è£…é€Ÿåº¦
          cache-dependency-path: '**/requirements.txt'  # å¦‚æœ‰requirements.txtå¯æŒ‡å®š
        timeout-minutes: 2

      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          set -euo pipefail
          pip install --upgrade pip
          pip install requests
          echo "[âœ…] Pythonä¾èµ–å®‰è£…å®Œæˆ | $(date +'%Y-%m-%d %H:%M:%S')"
        timeout-minutes: 2

      # ========== ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°s1.txtå¹¶æ¨é€ ==========
      - name: ğŸš€ è¿è¡ŒèŠ‚ç‚¹æ›´æ–°è„šæœ¬
        run: |
          set -euo pipefail
          if [ ! -f "update_nodes.py" ]; then
            echo "[âŒ] update_nodes.pyæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»ˆæ­¢æµç¨‹ | $(date +'%Y-%m-%d %H:%M:%S')"
            exit 1
          fi
          echo "[â„¹ï¸] å¼€å§‹è¿è¡ŒèŠ‚ç‚¹æ›´æ–°è„šæœ¬ | $(date +'%Y-%m-%d %H:%M:%S')"
          python update_nodes.py
          # æ‰“å°s1.txtå‰10è¡Œï¼Œå¿«é€ŸéªŒè¯å†…å®¹ï¼ˆæ•æ„Ÿä¿¡æ¯å¯æ³¨é‡Šï¼‰
          echo "[â„¹ï¸] s1.txtæœ€æ–°å†…å®¹ï¼ˆå‰10è¡Œï¼‰ï¼š"
          head -10 s1.txt || echo "[â„¹ï¸] s1.txtä¸ºç©º"
          echo "[âœ…] èŠ‚ç‚¹æ›´æ–°è„šæœ¬è¿è¡Œå®Œæˆ | $(date +'%Y-%m-%d %H:%M:%S')"
        env:
          PYTHONUNBUFFERED: "1"
        timeout-minutes: 3

      - name: ğŸ“¤ æ¨é€æ›´æ–°åçš„s1.txt
        run: |
          set -euo pipefail
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"
          
          # ä¼˜åŒ–å†²çªå¤„ç†ï¼šå…ˆæ‹‰å–æœ€æ–°ä»£ç ï¼Œå†å°è¯•æäº¤
          git pull origin ${{ github.ref_name }} --rebase --autostash || true
          
          if [ -f s1.txt ] && git diff --name-only --exit-code s1.txt; then
            echo "[â„¹ï¸] s1.txtæ— å˜æ›´ï¼Œè·³è¿‡æäº¤ | $(date +'%Y-%m-%d %H:%M:%S')"
            exit 0
          fi
          
          git add s1.txt
          git commit -m "æ›´æ–°è®¢é˜…: $(date +'%Y-%m-%d %H:%M:%S') [Auto]"
          # æ¨é€æ—¶æ·»åŠ é‡è¯•
          git push origin ${{ github.ref_name }} || (sleep 5 && git push origin ${{ github.ref_name }})
          echo "[âœ…] s1.txtå·²æ¨é€ | $(date +'%Y-%m-%d %H:%M:%S')"
        timeout-minutes: 2

      # ========== ç¬¬å››æ­¥ï¼šå¯åŠ¨SubConverterï¼ˆæ”¹å›å›ºå®š15ç§’ç­‰å¾…ï¼‰ ==========
      - name: ğŸ§¹ æ¸…ç†æ®‹ç•™å®¹å™¨
        if: always()
        run: |
          set -euo pipefail
          docker rm -f ${{ env.SUB_CONTAINER_NAME }} 2>/dev/null || echo "[â„¹ï¸] æ— æ®‹ç•™å®¹å™¨éœ€è¦æ¸…ç†"
          echo "[âœ…] å®¹å™¨æ¸…ç†å®Œæˆ | $(date +'%Y-%m-%d %H:%M:%S')"
        timeout-minutes: 1

      - name: ğŸ³ å¯åŠ¨SubConverteræœåŠ¡
        run: |
          set -euo pipefail
          # å¯åŠ¨å®¹å™¨å¹¶é™åˆ¶èµ„æºï¼ˆé¿å…å ç”¨è¿‡å¤šRunnerèµ„æºï¼‰
          docker run -d --name ${{ env.SUB_CONTAINER_NAME }} \
            -p ${{ env.SUB_CONTAINER_PORT }}:25500 \
            --memory=256m --cpus=0.5 \
            tindy2013/subconverter:latest
          
          # æ”¹å›å›ºå®š15ç§’ç­‰å¾…ï¼ˆæ›¿æ¢åŸåŠ¨æ€ç­‰å¾…é€»è¾‘ï¼‰
          echo "[â„¹ï¸] ç­‰å¾…SubConverteræœåŠ¡åˆå§‹åŒ–ï¼ˆå›ºå®š${{ env.SERVICE_WAIT_SECONDS }}ç§’ï¼‰ | $(date +'%Y-%m-%d %H:%M:%S')"
          sleep ${{ env.SERVICE_WAIT_SECONDS }}
          
          # è½»é‡éªŒè¯æœåŠ¡æ˜¯å¦å¯è®¿é—®ï¼ˆä»…åš2æ¬¡é‡è¯•ï¼Œå¤±è´¥ä¹Ÿè¾“å‡ºæ—¥å¿—ä½†ä¸å¼ºåˆ¶é€€å‡ºï¼‰
          echo "[â„¹ï¸] éªŒè¯SubConverteræœåŠ¡å¯ç”¨æ€§ | $(date +'%Y-%m-%d %H:%M:%S')"
          for i in {1..2}; do
            if curl -s -I http://localhost:${{ env.SUB_CONTAINER_PORT }}/sub | grep -q "200 OK"; then
              echo "[âœ…] SubConverteræœåŠ¡å°±ç»ª | $(date +'%Y-%m-%d %H:%M:%S')"
              exit 0
            fi
            echo "[âš ï¸] ç¬¬$iæ¬¡éªŒè¯å¤±è´¥ï¼Œ3ç§’åé‡è¯• | $(date +'%Y-%m-%d %H:%M:%S')"
            sleep 3
          done
          
          # å³ä½¿éªŒè¯å¤±è´¥ï¼Œä¹Ÿåªå‘Šè­¦å¹¶ç»§ç»­
          echo "[âš ï¸] SubConverteræœåŠ¡curléªŒè¯æœªé€šè¿‡ï¼Œä½†å®¹å™¨å·²å¯åŠ¨ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤ | $(date +'%Y-%m-%d %H:%M:%S')"
          docker logs ${{ env.SUB_CONTAINER_NAME }} | tail -20
        timeout-minutes: 3

      # ========== ç¬¬äº”æ­¥ï¼šè½¬æ¢Clashé…ç½®ï¼ˆå¼ºåŒ–éªŒè¯ï¼‰ ==========
      - name: ğŸ”„ è½¬æ¢V2è®¢é˜…ä¸ºClashé…ç½®
        run: |
          set -euo pipefail
          # å®šä¹‰éªŒè¯URLå‡½æ•°ï¼ˆå¼ºåŒ–å®¹é”™ï¼‰
          validate_url() {
            local url=$1
            echo "[â„¹ï¸] éªŒè¯è®¢é˜…åœ°å€ï¼š$url | $(date +'%Y-%m-%d %H:%M:%S')"
            for i in $(seq 1 ${{ env.CURL_RETRY }}); do
              status_code=$(curl -s --max-time 10 --head -L "$url" | grep -i "^HTTP" | awk '{print $2}')
              if [ "$status_code" = "200" ]; then
                echo "[âœ…] $url éªŒè¯é€šè¿‡ï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰ | $(date +'%Y-%m-%d %H:%M:%S')"
                return 0
              fi
              echo "[âš ï¸] $url éªŒè¯å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰ï¼Œç¬¬$iæ¬¡é‡è¯• | $(date +'%Y-%m-%d %H:%M:%S')"
              sleep 2
            done
            echo "[âŒ] $url éªŒè¯å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹ | $(date +'%Y-%m-%d %H:%M:%S')"
            exit 1
          }

          # å®šä¹‰ç”Ÿæˆé…ç½®å‡½æ•°ï¼ˆéªŒè¯æœ‰æ•ˆèŠ‚ç‚¹ï¼‰
          generate_clash_config() {
            local url=$1
            local output=$2
            echo "[â„¹ï¸] ç”ŸæˆClashé…ç½®ï¼š$output | $(date +'%Y-%m-%d %H:%M:%S')"
            curl --max-time ${{ env.CURL_TIMEOUT }} --retry ${{ env.CURL_RETRY }} \
              "http://localhost:${{ env.SUB_CONTAINER_PORT }}/sub?target=clash&url=$url&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" \
              -o "$output"
            
            # åŒé‡éªŒè¯ï¼šæ–‡ä»¶éç©º + åŒ…å«æœ‰æ•ˆèŠ‚ç‚¹
            if [ ! -s "$output" ]; then
              echo "[âŒ] $output å†…å®¹ä¸ºç©º | $(date +'%Y-%m-%d %H:%M:%S')"
              exit 1
            fi
            if ! grep -q "- name:" "$output"; then
              echo "[âŒ] $output æ— æœ‰æ•ˆèŠ‚ç‚¹ | $(date +'%Y-%m-%d %H:%M:%S')"
              cat "$output"  # æ‰“å°å†…å®¹ä¾¿äºæ’æŸ¥
              exit 1
            fi
            file_size=$(du -h "$output" | awk '{print $1}')
            node_count=$(grep -c "- name:" "$output")
            echo "[âœ…] $output ç”ŸæˆæˆåŠŸï¼ˆå¤§å°ï¼š$file_sizeï¼ŒèŠ‚ç‚¹æ•°ï¼š$node_countï¼‰ | $(date +'%Y-%m-%d %H:%M:%S')"
          }

          # æ‰¹é‡éªŒè¯è®¢é˜…åœ°å€
          validate_url "${{ env.SUB_URL_S }}"
          validate_url "${{ env.SUB_URL_S1 }}"
          validate_url "${{ env.SUB_URL_S2 }}"

          # æ‰¹é‡ç”Ÿæˆé…ç½®æ–‡ä»¶
          generate_clash_config "${{ env.SUB_URL_S }}" "./s-clash.yaml"
          generate_clash_config "${{ env.SUB_URL_S1 }}" "./s1-clash.yaml"
          generate_clash_config "${{ env.SUB_URL_S2 }}" "./s2-clash.yaml"
        timeout-minutes: 4

      # ========== ç¬¬å…­æ­¥ï¼šæ¨é€Clashé…ç½® ==========
      - name: ğŸ“¤ æ¨é€Clashé…ç½®æ–‡ä»¶
        run: |
          set -euo pipefail
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"
          
          git add s-clash.yaml s1-clash.yaml s2-clash.yaml
          
          if git diff --cached --quiet; then
            echo "[â„¹ï¸] Clashé…ç½®æ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æäº¤ | $(date +'%Y-%m-%d %H:%M:%S')"
            exit 0
          fi
          
          git commit -m "æ›´æ–°Clashé…ç½®: ${{ github.run_at }} [Auto]"
          # æ¨é€é‡è¯•+é™é»˜å¤±è´¥ï¼ˆé¿å…æ— æƒé™æ—¶æµç¨‹ä¸­æ–­ï¼‰
          git push origin ${{ github.ref_name }} || (sleep 3 && git push origin ${{ github.ref_name }} || echo "[âš ï¸] æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æƒé™é—®é¢˜")
          echo "[âœ…] Clashé…ç½®æ–‡ä»¶å·²æ¨é€ | $(date +'%Y-%m-%d %H:%M:%S')"
        timeout-minutes: 2

      # ========== æ”¶å°¾ï¼šæ¸…ç†èµ„æº ==========
      - name: ğŸ§¹ æ¸…ç†SubConverterå®¹å™¨
        if: always()
        run: |
          set -euo pipefail
          docker rm -f ${{ env.SUB_CONTAINER_NAME }} 2>/dev/null || true
          # å¯é€‰ï¼šæ¸…ç†æ— ç”¨é•œåƒï¼ˆèŠ‚çœç©ºé—´ï¼‰
          docker image prune -f
          echo "[âœ…] èµ„æºæ¸…ç†å®Œæˆ | $(date +'%Y-%m-%d %H:%M:%S')"
        timeout-minutes: 1
