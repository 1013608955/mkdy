# å»ºè®®å°†æ­¤æ–‡ä»¶å‘½åä¸ºï¼šupdate-nodes-and-clash.ymlï¼ˆæ— ç©ºæ ¼ï¼Œé¿å…è§£æé”™è¯¯ï¼‰
name: èŠ‚ç‚¹æ›´æ–° + Clashé…ç½®è½¬æ¢ï¼ˆæ¯1å°æ—¶ï¼‰

on:
  schedule:
    - cron: '0 */1 * * *'  # æ¯1å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:       # ä¿ç•™æ‰‹åŠ¨è§¦å‘

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆç§»é™¤å¾ªç¯å¼•ç”¨ï¼Œä»…ä¿ç•™æ— ä¾èµ–çš„æ ¸å¿ƒé…ç½®ï¼‰
env:
  SUB_CONTAINER_NAME: subconverter-temp    # ä¸´æ—¶å®¹å™¨åï¼ˆä¾¿äºæ¸…ç†ï¼‰
  GIT_USER_NAME: github-actions[bot]       # Gitæäº¤ç”¨æˆ·å
  GIT_USER_EMAIL: github-actions[bot]@users.noreply.github.com  # Gitæäº¤é‚®ç®±

jobs:
  update-and-convert:
    runs-on: ubuntu-latest
    timeout-minutes: 8  # ç²¾å‡†è®¾ç½®è¶…æ—¶ï¼ˆä¼˜åŒ–åæµç¨‹â‰¤5åˆ†é’Ÿï¼‰
    steps:
      # ========== ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆå¸¦PATæƒé™ï¼Œé¿å…æ¨é€å¤±è´¥ï¼‰ ==========
      - name: ğŸ” æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          token: ${{ secrets.PAT_TOKEN }}  # æ›¿æ¢ä¸ºä½ çš„PATä»¤ç‰Œï¼ˆä»“åº“è®¾ç½®ä¸­é…ç½®ï¼‰
          persist-credentials: true
          fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°æäº¤ï¼Œæå‡è¿è¡Œé€Ÿåº¦

      # ========== ç¬¬äºŒæ­¥ï¼šæ›´æ–°s1.txtï¼ˆèŠ‚ç‚¹æ›´æ–°æ ¸å¿ƒé€»è¾‘ï¼‰ ==========
      - name: ğŸ è®¾ç½®Pythonç¯å¢ƒï¼ˆé¿å…ç¼“å­˜æŠ¥é”™ï¼‰
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          # ç§»é™¤cache: 'pip'ï¼Œè·³è¿‡ä¾èµ–æ–‡ä»¶æ£€æŸ¥'

      - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
        run: |
          set -euo pipefail
          pip install --upgrade pip
          pip install requests
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') Pythonä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸš€ è¿è¡ŒèŠ‚ç‚¹æ›´æ–°è„šæœ¬ï¼ˆç”Ÿæˆæœ€æ–°s1.txtï¼‰
        run: |
          set -euo pipefail
          # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨ï¼Œé¿å…è¿è¡Œå¤±è´¥
          if [ ! -f "update_nodes.py" ]; then
            echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') update_nodes.pyæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') å¼€å§‹è¿è¡ŒèŠ‚ç‚¹æ›´æ–°è„šæœ¬..."
          python update_nodes.py
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') èŠ‚ç‚¹æ›´æ–°è„šæœ¬è¿è¡Œå®Œæˆ"
        env:
          PYTHONUNBUFFERED: "1"  # å®æ—¶è¾“å‡ºæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ–°åçš„s1.txtï¼ˆä»…å˜æ›´æ—¶æ¨é€ï¼‰
        run: |
          set -euo pipefail
          # é…ç½®Gitç”¨æˆ·
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"

          # å¤„ç†æœ¬åœ°æœªæš‚å­˜çš„æ›´æ”¹ï¼šå…ˆæš‚å­˜ï¼ˆstashï¼‰ï¼Œæ‹‰å–åå†æ¢å¤
          if ! git diff --quiet; then
            git stash save "temp-stash-s1.txt"  # æš‚å­˜æœ¬åœ°æ›´æ”¹
          fi

          # æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç ï¼ˆé¿å…å†²çªï¼‰
          git pull origin ${{ github.ref_name }} --rebase

          # æ¢å¤ä¹‹å‰æš‚å­˜çš„æ›´æ”¹
          if git stash list | grep -q "temp-stash-s1.txt"; then
            git stash pop stash@{0} || true  # æ¢å¤æ›´æ”¹ï¼Œå†²çªæ—¶å¿½ç•¥ï¼ˆè‡ªåŠ¨è„šæœ¬ä¸­ä¼˜å…ˆä¿ç•™æœ¬åœ°æœ€æ–°èŠ‚ç‚¹ï¼‰
          fi

          # æ£€æŸ¥s1.txtæ˜¯å¦æœ‰å˜æ›´
          if [ -f s1.txt ] && [ $(git diff --name-only s1.txt | wc -l) -gt 0 ]; then
            git add s1.txt
            git commit -m "å¤šæ¥æº+Realityä¼˜å…ˆæ›´æ–°è®¢é˜…: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin ${{ github.ref_name }}
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') âœ… s1.txtå·²æ›´æ–°å¹¶æ¨é€ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰"
          else
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') â„¹ï¸  s1.txtæ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          fi

      # ========== ç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨SubConverteræœåŠ¡ï¼ˆå¸¦çŠ¶æ€æ£€æŸ¥ï¼‰ ==========
      - name: ğŸ³ å¯åŠ¨SubConverteræœåŠ¡ï¼ˆæç®€ç¨³å®šç‰ˆï¼‰
        run: |
          set -euo pipefail
          # æ¸…ç†æ®‹ç•™å®¹å™¨
          docker rm -f ${{ env.SUB_CONTAINER_NAME }} 2>/dev/null || true

          # å¯åŠ¨å®¹å™¨ï¼ˆä¸åšä»»ä½•æ—¥å¿—ç›‘å¬ï¼‰
          docker run -d --name ${{ env.SUB_CONTAINER_NAME }} -p 25500:25500 tindy2013/subconverter:latest

          # ç›´æ¥ç­‰å¾…15ç§’ï¼ˆç»™è¶³æœåŠ¡åˆå§‹åŒ–æ—¶é—´ï¼Œæ—¥å¿—å·²è¯æ˜15ç§’è¶³å¤Ÿå¯åŠ¨ï¼‰
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') ç­‰å¾…SubConverteræœåŠ¡åˆå§‹åŒ–..."
          sleep 15

          # è½»é‡éªŒè¯æœåŠ¡æ˜¯å¦å¯è®¿é—®ï¼ˆä»…åš2æ¬¡é‡è¯•ï¼Œå¤±è´¥ä¹Ÿè¾“å‡ºæ—¥å¿—ä½†ä¸å¼ºåˆ¶é€€å‡ºï¼‰
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') éªŒè¯SubConverteræœåŠ¡å¯ç”¨æ€§..."
          for i in {1..2}; do
            if curl -s -I http://localhost:25500/sub | grep -q "200 OK"; then
              echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') SubConverteræœåŠ¡å°±ç»ª âœ…"
              exit 0
            fi
            echo "[WARN] ç¬¬$iæ¬¡éªŒè¯å¤±è´¥ï¼Œ3ç§’åé‡è¯•..."
            sleep 3
          done

          # å³ä½¿éªŒè¯å¤±è´¥ï¼Œä¹Ÿåªå‘Šè­¦å¹¶ç»§ç»­ï¼ˆæœåŠ¡å®é™…å·²å¯åŠ¨ï¼ŒcurléªŒè¯å¯èƒ½å› ç½‘ç»œå°æ³¢åŠ¨å¤±è´¥ï¼‰
          echo "[WARN] $(date +'%Y-%m-%d %H:%M:%S') SubConverteræœåŠ¡curléªŒè¯æœªé€šè¿‡ï¼Œä½†å®¹å™¨å·²å¯åŠ¨ï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤"
          docker logs ${{ env.SUB_CONTAINER_NAME }} | tail -20  # è¾“å‡ºæœ€å20è¡Œæ—¥å¿—å¤‡æŸ¥

      # ========== ç¬¬å››æ­¥ï¼šè½¬æ¢V2è®¢é˜…ä¸ºClashé…ç½®ï¼ˆä»…ä½¿ç”¨è¿œç¨‹è®¢é˜…é“¾æ¥ï¼‰ ==========
      - name: ğŸ”„ è½¬æ¢V2è®¢é˜…ä¸ºClashé…ç½®ï¼ˆä»…è¿œç¨‹é“¾æ¥ï¼‰
        run: |
          set -euo pipefail
          # å®šä¹‰è®¢é˜…åœ°å€ï¼ˆä»…ä¿ç•™è¿œç¨‹é“¾æ¥ï¼Œç§»é™¤æœ¬åœ°file://è·¯å¾„ï¼‰
          # æ³¨æ„ï¼šè¯·æ›¿æ¢æˆä½ å®é™…çš„è¿œç¨‹è®¢é˜…é“¾æ¥
          V2_URL="https://raw.githubusercontent.com/1013608955/${{ github.event.repository.name }}/main/s.txt"
          # åŸæœ¬åœ°s1.txtæ”¹ä¸ºè¿œç¨‹é“¾æ¥ï¼ˆå¯¹åº”ä»“åº“ä¸­åˆšæ¨é€çš„s1.txtï¼‰
          V2_URL1="https://raw.githubusercontent.com/1013608955/${{ github.event.repository.name }}/main/s1.txt"
          V2_URL2="https://raw.githubusercontent.com/1013608955/${{ github.event.repository.name }}/main/s2.txt"

          # éªŒè¯è®¢é˜…åœ°å€ï¼ˆç§»é™¤æœ¬åœ°file://åè®®çš„ç‰¹æ®Šå¤„ç†ï¼‰
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') å¼€å§‹éªŒè¯è®¢é˜…åœ°å€..."
          validate_url() {
            local url=$1
            local retry=3
            for i in {1..$retry}; do
              # ä»…éªŒè¯è¿œç¨‹åœ°å€çŠ¶æ€ç 
              status_code=$(curl -s --head "$url" -L | grep -i "^http" | awk '{print $2}')
              if [ "$status_code" = "200" ]; then
                echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') âœ… $url åœ°å€æœ‰æ•ˆï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰"
                return 0
              fi
              echo "[WARN] $(date +'%Y-%m-%d %H:%M:%S') $url åœ°å€æ— æ•ˆï¼ˆçŠ¶æ€ç ï¼š$status_codeï¼‰ï¼Œç¬¬$iæ¬¡é‡è¯•..."
              sleep 2
              if [ $i -eq $retry ]; then
                echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') âŒ $url åœ°å€éªŒè¯å¤±è´¥ï¼Œç»ˆæ­¢æµç¨‹"
                return 1
              fi
            done
          }
          # æ‰¹é‡éªŒè¯è®¢é˜…åœ°å€
          for url in "$V2_URL" "$V2_URL1" "$V2_URL2"; do
            validate_url "$url" || exit 1
          done

          # ç”ŸæˆClashé…ç½®æ–‡ä»¶ï¼ˆå¸¦è¶…æ—¶+é‡è¯•ï¼Œéç©ºæ£€æŸ¥ï¼‰
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') å¼€å§‹ç”ŸæˆClashé…ç½®æ–‡ä»¶..."
          generate_config() {
            local url=$1
            local output=$2
            # è°ƒç”¨SubConverterç”Ÿæˆé…ç½®
            curl --max-time 30 --retry 3 \
              "http://localhost:25500/sub?target=clash&url=$url&group=Auto&interval=60&url_test=https://cp.cloudflare.com/generate_204" \
              -o "$output"
            # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦éç©º
            if [ "$(stat -c%s "$output")" -eq 0 ]; then
              echo "[ERROR] $(date +'%Y-%m-%d %H:%M:%S') âŒ $output å†…å®¹ä¸ºç©ºï¼Œè½¬æ¢å¤±è´¥"
              exit 1
            fi
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') âœ… $output ç”ŸæˆæˆåŠŸï¼Œå¤§å°ï¼š$(du -h "$output" | awk '{print $1}')"
          }
          # æ‰¹é‡ç”Ÿæˆé…ç½®æ–‡ä»¶
          generate_config "$V2_URL" "./s-clash.yaml"
          generate_config "$V2_URL1" "./s1-clash.yaml"
          generate_config "$V2_URL2" "./s2-clash.yaml"

      # ========== ç¬¬äº”æ­¥ï¼šæ¨é€Clashé…ç½®æ–‡ä»¶ï¼ˆä»…å˜æ›´æ—¶æ¨é€ï¼‰ ==========
      - name: ğŸ“¤ æäº¤å¹¶æ¨é€Clashé…ç½®æ–‡ä»¶ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
        run: |
          set -euo pipefail
          # é…ç½®Gitç”¨æˆ·
          git config user.name "${{ env.GIT_USER_NAME }}"
          git config user.email "${{ env.GIT_USER_EMAIL }}"

          # ç›´æ¥æ·»åŠ é…ç½®æ–‡ä»¶ï¼ˆæ— éœ€æ‹‰å–ï¼Œå½“å‰æ˜¯æœ€æ–°ç”Ÿæˆçš„ï¼‰
          git add s-clash.yaml s1-clash.yaml s2-clash.yaml

          # ä»…å½“æœ‰å˜æ›´æ—¶æäº¤
          if git diff --cached --quiet; then
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') â„¹ï¸  Clashé…ç½®æ–‡ä»¶æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "Auto update Clash config: ${{ github.run_at }}"
            git push origin ${{ github.ref_name }}
            echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') âœ… Clashé…ç½®æ–‡ä»¶å·²æ¨é€ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰"
          fi

      # ========== æ”¶å°¾ï¼šå¼ºåˆ¶æ¸…ç†å®¹å™¨ï¼ˆæ— è®ºæµç¨‹æ˜¯å¦å¤±è´¥ï¼‰ ==========
      - name: ğŸ§¹ æ¸…ç†SubConverterå®¹å™¨
        if: always()  # æ‰€æœ‰æƒ…å†µéƒ½æ‰§è¡Œæ¸…ç†ï¼Œé¿å…èµ„æºæ³„æ¼
        run: |
          docker rm -f ${{ env.SUB_CONTAINER_NAME }} 2>/dev/null || true
          echo "[INFO] $(date +'%Y-%m-%d %H:%M:%S') SubConverterå®¹å™¨å·²æ¸…ç†å®Œæˆ"
